pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- shark
-- by a2
local score
local game_objects
local shark

function _init()
  --start score counter at zero
  score=0

  --create the game objects
  game_objects={}

  --create initial objects
  shark=make_shark(8,60)

  --start the music
  --music(0)
end

function _update()
  --update all game objects
  local obj
  for obj in all(game_objects) do
    obj:update()
  end

  --filter out "dead" objects
  filter_out_finished(game_objects)
end

function _draw()
  cls(0)--clear the screen
  draw_stars()--draw stars (seeds rng)

  local obj
  for obj in all(game_objects) do
    if (obj.visible) obj:draw()
  end

  --small ship
  spr(1,40,40)

  --big ship
  pal(14,12)
  sspr(16,32,16,16,50,50)
  pal()

  --big ship
  pal(14,10)
  sspr(16,32,16,16,70,70)
  pal()

  rectfill(0,0,128,6,5)
  --print("score:"..score,1,1,7)
  print("game_objects: "..#game_objects,1,1,7)
end

function draw_stars()
  srand(1)
  for i=1,50 do
    pset(rndb(0,127),rndb(8,127),rndb(5,7))
  end
  srand(time())
end
-->8
--makers
function noop()
end

function make_game_object(name,x,y,props)
  local obj={
    name=name,
    x=x,
    y=y,
    visible=true,
    update=noop,
    draw=noop,
    draw_bounding_box=function(self,color)
      rect(self.x,self.y,self.x+self.width,self.y+self.height,color)
    end,
    center=function(self)
      return self.x+self.width/2,self.y+self.height/2
    end,
    overlaps=function(self,other)
      return bounding_boxes_overlapping(self,other)
    end
  }
  --add additional properties
  local key,value
  for key,value in pairs(props) do
    obj[key]=value
  end
  --add it to the list of game objects
  add(game_objects,obj)
  --return the game object
  return obj
end

--hit detection helper functions
function rects_overlapping(left1,top1,right1,bottom1,left2,top2,right2,bottom2)
  return right1>left2 and right2>left1 and bottom1>top2 and bottom2>top1
end

function bounding_boxes_overlapping(obj1,obj2)
  return rects_overlapping(obj1.x,obj1.y,obj1.x+obj1.width,obj1.y+obj1.height,obj2.x,obj2.y,obj2.x+obj2.width,obj2.y+obj2.height)
end

function for_each_game_object(name,callback)
  local obj
  for obj in all(game_objects) do
    if obj.name==name then
      callback(obj)
    end
  end
end

function make_shark(x,y)
  return make_game_object("shark",x,y,{
    width=8,
    height=8,
    emitter_location=function(self)
      return self.x+6,self.y
    end,
    update=function(self)
      --shoot on (z)
      if btn(4) then
        if self.last_laser then
          self.last_laser.x-=1
          self.last_laser.width+=1
        else
          local x,y=self:emitter_location()
          self.last_laser=make_laser(x,y)
        end
      else
        --shark only move when not shooting lasers
        if (btn(2) and self.y>8) self.y-=1
        if (btn(3) and self.y+self.height<128) self.y+=1
        self.last_laser=nil
      end
    end,
    draw=function(self)
      palt(0,false)
      palt(1,true)
      spr(0,self.x,self.y)
      palt()
    end,
  })
end

function make_laser(x,y)
  return make_game_object("laser",x,y,{
    width=1,
    height=1,
    color=8,--rndb(8,10),
    update=function(self)
      self.x+=1
      if (self.x>128) self.finished=true
    end,
    draw=function(self)
      line(self.x,self.y,self.x+self.width-1,self.y+self.height-1,self.color)
    end
  })
end
-->8
--helpers
function rndb(low,high)
  return flr(rnd(high-low+1)+low)
end

function ternary(condition,if_true,if_false)
  return condition and if_true or if_false
end

--increment a counter, wrapping to 20000 if it risks overflowing
function increment_counter(n)
  return n+ternary(n>32000,-12000,1)
end

--decrement a counter but not below 0
function decrement_counter(n)
  return max(0,n-1)
end

function filter_out_finished(list)
  local item
  for item in all(list) do
    if item.finished then
      del(list,item)
    end
  end
end
__gfx__
111155e1000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11156111005555590000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
61166611055e55a80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666665ee55500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666066055e55a80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
61766771005555590000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11161111000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111611111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111661155110000000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111155555c11000000005550055a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
61111166666611110000055555555589000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
61116666666666110005555555555589000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6616666666666661055555ee5555555a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666006665555eeee55555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666006665555eeee55555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666055555ee5555555a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
661776666666fff10005555555555589000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
61117766667777110000055555555589000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6111176661111111000000005550055a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111166111111110000000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010200000c6100c6100c6100c6100c6100c6100c6100c6100d6000d6000d6000d6000d60016600026000160016600166001660005600076000860008600086000860000600006000060000600006000060000600
000100003a010330102b01019010120100b0100801005010040100301002010020100101005000040000300002000010000100010000076001000010000110001300014000100000060000600006000060000600
